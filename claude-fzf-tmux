#!/usr/bin/env bash
#
# claude-fzf-tmux - Tmux integration helpers for claude-fzf
#

set -euo pipefail

# Check if we're running inside tmux
is_in_tmux() {
    [[ -n "${TMUX:-}" ]]
}

# Get tmux session name from project path
# /Users/jh3/Development/claude-fzf -> claude-fzf
project_to_session_name() {
    local project_path="$1"
    basename "$project_path"
}

# Check if a tmux session exists
session_exists() {
    local session_name="$1"
    tmux has-session -t "=$session_name" 2>/dev/null
}

# List all tmux sessions (just names)
list_sessions() {
    tmux list-sessions -F "#{session_name}" 2>/dev/null || true
}

# Create a new tmux session with standard 4-window layout
# Does NOT attach - caller decides whether to switch
create_project_session() {
    local session_name="$1"
    local project_path="$2"

    # Create session with first window named "claude"
    tmux new-session -d -s "$session_name" -n "claude" -c "$project_path"

    # Create remaining windows
    tmux new-window -t "$session_name" -n "logs" -c "$project_path"
    tmux new-window -t "$session_name" -n "edit" -c "$project_path"
    tmux new-window -t "$session_name" -n "scratch" -c "$project_path"

    # Select the claude window
    tmux select-window -t "$session_name:claude"
}

# Switch to a session (from within tmux)
switch_to_session() {
    local session_name="$1"
    tmux switch-client -t "=$session_name"
}

# Run a command in a specific window of a session
run_in_window() {
    local session_name="$1"
    local window_name="$2"
    local command="$3"

    tmux send-keys -t "$session_name:$window_name" "$command" Enter
}

# Get the current tmux session name
current_session() {
    tmux display-message -p "#{session_name}" 2>/dev/null || echo ""
}

# Export functions for use by other scripts
export -f is_in_tmux project_to_session_name session_exists list_sessions
export -f create_project_session switch_to_session run_in_window current_session
